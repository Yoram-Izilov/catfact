name: Deploy and Test Application

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  setup-minikube:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Install dependencies
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y conntrack curl

      # Set up Minikube
      - name: Start Minikube
        uses: manusa/actions-setup-minikube@v2
        with:
          minikube version: 'v1.30.1'
          kubernetes version: 'v1.26.3'
          driver: docker

      # Deploy the Helm chart
      - name: Deploy Helm Chart
        run: |
          helm install cat-fact-app ./chart

      # Wait for application to be ready
      - name: Wait for Pods
        run: |
          kubectl wait --for=condition=ready pod -l app=cat-fact-app --timeout=90s

      # Run Tests on REST API
      - name: Test REST API Endpoints
        run: |
          POD_IP=$(kubectl get pod -l app=cat-fact-app -o jsonpath="{.items[0].status.podIP}")
          echo "Pod IP: $POD_IP"
          curl -f http://$POD_IP:80/fact || exit 1
          curl -f http://$POD_IP:80/health || exit 1